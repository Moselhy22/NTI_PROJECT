{% extends "base.html" %}
{% block content %}

{% if session.user_type == 'doctor' %}
    <h2>ğŸ‘¨â€âš•ï¸ {{ 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨' if session.get('lang') == 'ar' else 'Doctor Dashboard' }}</h2>
    <p>{{ 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¯. ' if session.get('lang') == 'ar' else 'Welcome, Dr. ' }}{{ session.name }}!</p>

    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-top: 20px; border-{{ 'right' if session.get('lang') == 'ar' else 'left' }}: 4px solid #3498db;">
        <h3>ğŸ“… {{ 'Ø¬Ø¯ÙˆÙ„Ø© Ø²ÙŠØ§Ø±Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø±ÙŠØ¶' if session.get('lang') == 'ar' else 'Schedule Patient Revisit' }}</h3>
        <form method="POST" action="/schedule-appointment">
            <label>{{ 'Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *' if session.get('lang') == 'ar' else 'Patient Username or Email *' }}</label>
            <input type="text" name="patient_identifier" required placeholder="{{ 'Ù…Ø«Ø§Ù„: omar.m Ø£Ùˆ omar@example.com' if session.get('lang') == 'ar' else 'e.g., omar.m or omar@example.com' }}" style="width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; {{ 'direction: rtl;' if session.get('lang') == 'ar' else '' }}">
            <label>{{ 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø© *' if session.get('lang') == 'ar' else 'Visit Date *' }}</label>
            <input type="date" name="visit_date" required style="width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px;">
            <label>{{ 'ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø© *' if session.get('lang') == 'ar' else 'Visit Time *' }}</label>
            <input type="time" name="visit_time" required style="width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px;">
            <button type="submit" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 10px;">âœ… {{ 'Ø¬Ø¯ÙˆÙ„Ø© Ø²ÙŠØ§Ø±Ø© Ù…ØªØ§Ø¨Ø¹Ø©' if session.get('lang') == 'ar' else 'Schedule Revisit' }}</button>
        </form>
    </div>

    <h3 style="margin-top: 25px;">ğŸ“… {{ 'Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©' if session.get('lang') == 'ar' else 'Your Scheduled Appointments' }}</h3>
    {% if appointments %}
        {% for appt in appointments %}
        <div style="background: #f0fdf4; border-{{ 'right' if session.get('lang') == 'ar' else 'left' }}: 4px solid #10b981; padding: 16px; border-radius: 10px; margin: 12px 0; {{ 'direction: rtl; text-align: right;' if session.get('lang') == 'ar' else '' }}">
            <p><strong>ğŸ‘¤ {{ 'Ø§Ù„Ù…Ø±ÙŠØ¶:' if session.get('lang') == 'ar' else 'Patient:' }}</strong> {{ appt.patient_email }}</p>
            <p>ğŸ“† {{ appt.visit_date }} {{ 'ÙÙŠ' if session.get('lang') == 'ar' else 'at' }} {{ appt.visit_time }}</p>
            <p>âœ… {{ appt.status }}</p>
        </div>
        {% endfor %}
    {% else %}
        <p>{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¬Ø¯ÙˆÙ„Ø©.' if session.get('lang') == 'ar' else 'No scheduled appointments.' }}</p>
    {% endif %}
{% else %}
    <h2>ğŸ‘¤ {{ 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙŠØ¶' if session.get('lang') == 'ar' else 'Patient Dashboard' }}</h2>
    <p><strong>{{ 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' if session.get('lang') == 'ar' else 'Welcome, ' }}{{ session.name }}!</strong></p>

    <!-- MULTILINGUAL TABS -->
    <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; {{ 'flex-direction: row-reverse;' if session.get('lang') == 'ar' else '' }}">
        <a href="#calendar" style="text-decoration: none;">
            <button style="padding: 10px 16px; background: {{ 'white' if request.args.get('tab') == 'vitals' or request.args.get('tab') == 'reminders' else '#3498db' }}; color: {{ 'black' if request.args.get('tab') == 'vitals' or request.args.get('tab') == 'reminders' else 'white' }}; border: 1px solid #3498db; border-radius: 8px; cursor: pointer; font-family: {{ "'Tajawal', sans-serif" if session.get('lang') == 'ar' else "'Inter', sans-serif" }};">
                ğŸ“… {{ 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ…' if session.get('lang') == 'ar' else 'Calendar' }}
            </button>
        </a>
        <a href="#vitals" style="text-decoration: none;">
            <button style="padding: 10px 16px; background: {{ 'white' if request.args.get('tab') == 'calendar' or request.args.get('tab') == 'reminders' else '#3498db' }}; color: {{ 'black' if request.args.get('tab') == 'calendar' or request.args.get('tab') == 'reminders' else 'white' }}; border: 1px solid #3498db; border-radius: 8px; cursor: pointer; font-family: {{ "'Tajawal', sans-serif" if session.get('lang') == 'ar' else "'Inter', sans-serif" }};">
                â¤ï¸ {{ 'Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©' if session.get('lang') == 'ar' else 'Vitals' }}
            </button>
        </a>
        <a href="#reminders" style="text-decoration: none;">
            <button style="padding: 10px 16px; background: {{ 'white' if request.args.get('tab') == 'calendar' or request.args.get('tab') == 'vitals' else '#3498db' }}; color: {{ 'black' if request.args.get('tab') == 'calendar' or request.args.get('tab') == 'vitals' else 'white' }}; border: 1px solid #3498db; border-radius: 8px; cursor: pointer; font-family: {{ "'Tajawal', sans-serif" if session.get('lang') == 'ar' else "'Inter', sans-serif" }};">
                ğŸ”” {{ 'Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª' if session.get('lang') == 'ar' else 'Reminders' }}
            </button>
        </a>
    </div>

    <!-- CALENDAR SECTION -->
    <div id="calendar" style="margin-top: 20px;">
        <h3>{{ 'ğŸ“… ØªÙ‚ÙˆÙŠÙ…ÙŠ Ø§Ù„ØµØ­ÙŠ' if session.get('lang') == 'ar' else 'ğŸ“… My Health Calendar' }}</h3>
        <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 280px; background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <h4 style="text-align: center; margin-bottom: 15px; font-family: {{ "'Tajawal', sans-serif" if session.get('lang') == 'ar' else "'Inter', sans-serif" }};">{{ 'ÙŠÙ†Ø§ÙŠØ± 2025' if session.get('lang') == 'ar' else 'January 2025' }}</h4>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: #64748b; margin-bottom: 10px; font-size: 0.85rem; font-family: {{ "'Tajawal', sans-serif" if session.get('lang') == 'ar' else "'Inter', sans-serif" }};">
                    {% if session.get('lang') == 'ar' %}
                    <div>Ø³Ø¨Øª</div><div>Ø¬Ù…Ø¹Ø©</div><div>Ø®Ù…ÙŠØ³</div><div>Ø£Ø±Ø¨Ø¹Ø§Ø¡</div><div>Ø«Ù„Ø§Ø«Ø§Ø¡</div><div>Ø¥Ø«Ù†ÙŠÙ†</div><div>Ø£Ø­Ø¯</div>
                    {% else %}
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    {% endif %}
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 14px;">
                    <div></div><div></div><div></div>
                    <div style="background: #dbeafe; border-radius: 4px; padding: 4px;">1</div>
                    <div>2</div><div>3</div><div>4</div>
                    <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div>
                    <div>12</div><div>13</div><div>14</div>
                    <div style="background: #dcfce7; border-radius: 4px; padding: 4px; color: #166534;">15</div>
                    <div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div>
                    <div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div>
                    <div>29</div><div>30</div><div>31</div>
                </div>
            </div>

            <div style="flex: 1; min-width: 280px;">
                <h4 style="font-family: {{ "'Tajawal', sans-serif" if session.get('lang') == 'ar' else "'Inter', sans-serif" }};">{{ 'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©' if session.get('lang') == 'ar' else 'Upcoming Appointments' }}</h4>
                {% if appointments %}
                    {% for appt in appointments %}
                    <div style="background: #f0f9ff; border-{{ 'right' if session.get('lang') == 'ar' else 'left' }}: 4px solid #3498db; padding: 16px; border-radius: 10px; margin-bottom: 12px; {{ 'direction: rtl; text-align: right;' if session.get('lang') == 'ar' else '' }}">
                        <p><strong>ğŸ‘¨â€âš•ï¸ {{ 'Ø¯. ' if session.get('lang') == 'ar' else 'Dr. ' }}{{ appt.doctor_name }}</strong></p>
                        <p>ğŸ“† {{ appt.visit_date }} {{ 'ÙÙŠ' if session.get('lang') == 'ar' else 'at' }} {{ appt.visit_time }}</p>
                        <p>âœ… {{ appt.status }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #64748b;">{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯.' if session.get('lang') == 'ar' else 'No appointments.' }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- VITALS SECTION (DYNAMIC) -->
    <div id="vitals" style="margin-top: 20px; display: none;">
        <h3>{{ 'â¤ï¸ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ' if session.get('lang') == 'ar' else 'â¤ï¸ Real-Time Vitals Monitoring' }}</h3>
        
        <!-- VITALS SUB-TABS -->
        <div style="display: flex; gap: 10px; margin: 15px 0; {{ 'flex-direction: row-reverse;' if session.get('lang') == 'ar' else '' }}">
            <button id="realtime-tab" style="padding: 8px 16px; background: #3498db; color: white; border: 1px solid #3498db; border-radius: 8px; cursor: pointer;">{{ 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ' if session.get('lang') == 'ar' else 'Real-Time' }}</button>
            <button id="history-tab" style="padding: 8px 16px; background: #e2e8f0; color: black; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer;">{{ 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ' if session.get('lang') == 'ar' else 'History' }}</button>
        </div>

        <!-- REAL-TIME CONTENT -->
        <div id="realtime-content">
            <div id="vitals-container">
                <p>{{ 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø³ÙˆØ§Ø±Ùƒ Ø§Ù„ØµØ­ÙŠ...' if session.get('lang') == 'ar' else 'Loading real-time data from your Smart Health Band...' }}</p>
            </div>
            <p style="margin-top: 20px; color: #64748b;"><em>{{ 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ¬Ø¯Ø¯ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù.' if session.get('lang') == 'ar' else 'Data updates every 5 seconds.' }}</em></p>
        </div>

        <!-- HISTORY CONTENT - 3 GOOGLE CHARTS -->
        <div id="history-content" style="display: none;">
            <h4 style="margin: 15px 0;">{{ 'ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ' if session.get('lang') == 'ar' else 'ğŸ“Š Historical Data Visualization' }}</h4>
            
            <!-- TIME RANGE SELECTOR -->
            <div style="display: flex; gap: 10px; margin: 10px 0; {{ 'flex-direction: row-reverse;' if session.get('lang') == 'ar' else '' }}">
                <button class="history-range" data-range="day" style="padding: 6px 12px; background: #3498db; color: white; border: 1px solid #3498db; border-radius: 6px; cursor: pointer;">{{ 'Ø§Ù„ÙŠÙˆÙ…' if session.get('lang') == 'ar' else 'Day' }}</button>
                <button class="history-range" data-range="week" style="padding: 6px 12px; background: #e2e8f0; color: black; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer;">{{ 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' if session.get('lang') == 'ar' else 'Week' }}</button>
                <button class="history-range" data-range="month" style="padding: 6px 12px; background: #e2e8f0; color: black; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer;">{{ 'Ø§Ù„Ø´Ù‡Ø±' if session.get('lang') == 'ar' else 'Month' }}</button>
            </div>

            <!-- 3 GOOGLE CHARTS -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <!-- Heart Rate - LINE CHART -->
                <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; border-left: 4px solid #10b981;">
                    <h5 style="margin-bottom: 10px; text-align: {{ 'right' if session.get('lang') == 'ar' else 'left' }};">{{ 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (Ø®Ø·)' if session.get('lang') == 'ar' else 'Heart Rate (Line)' }}</h5>
                    <div id="heart-rate-chart" style="height: 200px;"></div>
                </div>
                
                <!-- SpO2 - BAR CHART -->
                <div style="background: #f0f9ff; padding: 15px; border-radius: 12px; border-left: 4px solid #3498db;">
                    <h5 style="margin-bottom: 10px; text-align: {{ 'right' if session.get('lang') == 'ar' else 'left' }};">{{ 'ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† (Ø¹Ù…ÙˆØ¯ÙŠ)' if session.get('lang') == 'ar' else 'SpOâ‚‚ (Bar)' }}</h5>
                    <div id="spo2-chart" style="height: 200px;"></div>
                </div>
                
                <!-- Temperature - PIE CHART -->
                <div style="background: #fef3c7; padding: 15px; border-radius: 12px; border-left: 4px solid #d97706;">
                    <h5 style="margin-bottom: 10px; text-align: {{ 'right' if session.get('lang') == 'ar' else 'left' }};">{{ 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Ø¯Ø§Ø¦Ø±ÙŠØ©)' if session.get('lang') == 'ar' else 'Temperature (Pie)' }}</h5>
                    <div id="temp-chart" style="height: 200px;"></div>
                </div>
            </div>
            
            <p id="chart-info" style="margin-top: 10px; color: #64748b; font-style: italic;">
                {{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¹Ø±Ø¶. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª.' if session.get('lang') == 'ar' else 'Not enough data to display. Wait for more readings to be collected.' }}
            </p>
        </div>

        <!-- GOOGLE CHARTS LIBRARY -->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script>
        // Load Google Charts
        google.charts.load('current', {'packages':['corechart']});
        
        // Real-time vitals loading - WITH CLASS NAMES FOR CHATBOT
        function loadVitals() {
            const username = "{{ session.username }}";
            fetch(`/api/vitals/${username}`)
                .then(response => response.json())
                .then(data => {
                    // Store data in global variable for chatbot access
                    window.currentVitals = data;
                    
                    document.getElementById('vitals-container').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #10b981;">
                                <h4>{{ 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨' if session.get('lang') == 'ar' else 'Heart Rate' }}</h4>
                                <p style="font-size: 2rem; font-weight: 700; color: #065f46;" class="heart-rate-value">${data.heart_rate || '--'} <span style="font-size: 1rem;">{{ 'Ù†Ø¨Ø¶Ø©/Ø¯Ù‚ÙŠÙ‚Ø©' if session.get('lang') == 'ar' else 'bpm' }}</span></p>
                            </div>
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #3498db;">
                                <h4>{{ 'ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†' if session.get('lang') == 'ar' else 'SpOâ‚‚' }}</h4>
                                <p style="font-size: 2rem; font-weight: 700; color: #1e40af;" class="spo2-value">${data.spo2 || '--'} <span style="font-size: 1rem;">%</span></p>
                            </div>
                            <div style="background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #d97706;">
                                <h4>{{ 'Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¬Ø³Ù…' if session.get('lang') == 'ar' else 'Body Temp' }}</h4>
                                <p style="font-size: 2rem; font-weight: 700; color: #9a3412;" class="temp-value">${data.temp || '--'} <span style="font-size: 1rem;">Â°C</span></p>
                            </div>
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #10b981;">
                                <h4>{{ 'ÙƒØ´Ù Ø§Ù„Ø³Ù‚ÙˆØ·' if session.get('lang') == 'ar' else 'Fall Detection' }}</h4>
                                <p style="font-size: 1.2rem; font-weight: 600; color: ${data.fall ? '#dc2626' : '#065f46'};" class="fall-status">
                                    ${data.fall ? '{{ 'âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø³Ù‚ÙˆØ·!' if session.get('lang') == 'ar' else 'âš ï¸ Fall Detected!' }}' : '{{ 'âœ… Ø·Ø¨ÙŠØ¹ÙŠ' if session.get('lang') == 'ar' else 'âœ… Normal' }}'}
                                </p>
                            </div>
                        </div>
                    `;
                })
                .catch(() => {
                    document.getElementById('vitals-container').innerHTML = 
                        '<p style="color: #ef4444;">âš ï¸ {{ 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©. Ù‡Ù„ Ø³ÙˆØ§Ø±Ùƒ Ù…ØªØµÙ„ØŸ' if session.get('lang') == 'ar' else 'Failed to load vitals. Is your band connected?' }}</p>';
                });
        }

        // GOOGLE CHARTS FUNCTION
        let heartRateChart, spo2Chart, tempChart;
        
        function drawCharts(data) {
            // Format timestamps for chart labels
            const formattedTimes = data.timestamps.map(ts => {
                const date = new Date(ts);
                return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            });
            
            // Create data tables
            const heartRateData = [['Time', 'Heart Rate']];
            const spo2Data = [['Time', 'SpOâ‚‚']];
            const tempData = [['Temperature', 'Count']];
            
            for (let i = 0; i < data.timestamps.length; i++) {
                heartRateData.push([formattedTimes[i], data.heart_rate[i]]);
                spo2Data.push([formattedTimes[i], data.spo2[i]]);
                tempData.push([`${data.temperature[i]}Â°C`, 1]); // For pie chart
            }
            
            // Draw Heart Rate Line Chart
            const heartRateOptions = {
                title: '{{ 'Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¨' if session.get('lang') == 'ar' else 'Heart Rate' }}',
                curveType: 'function',
                legend: { position: 'bottom' },
                backgroundColor: '#f0fdf4',
                width: '100%',
                height: '100%',
                fontSize: 14,
                titleTextStyle: {
                    fontSize: 16,
                    bold: true
                },
                hAxis: {
                    textStyle: {
                        fontSize: 12
                    }
                },
                vAxis: {
                    viewWindow: {
                        min: 40,
                        max: 120
                    }
                }
            };
            
            const heartRateDataTable = google.visualization.arrayToDataTable(heartRateData);
            heartRateChart = new google.visualization.LineChart(document.getElementById('heart-rate-chart'));
            heartRateChart.draw(heartRateDataTable, heartRateOptions);
            
            // Draw SpO2 Bar Chart
            const spo2Options = {
                title: '{{ 'ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†' if session.get('lang') == 'ar' else 'SpOâ‚‚' }}',
                legend: { position: 'bottom' },
                backgroundColor: '#f0f9ff',
                width: '100%',
                height: '100%',
                fontSize: 14,
                titleTextStyle: {
                    fontSize: 16,
                    bold: true
                },
                hAxis: {
                    textStyle: {
                        fontSize: 12
                    }
                },
                vAxis: {
                    viewWindow: {
                        min: 90,
                        max: 100
                    }
                }
            };
            
            const spo2DataTable = google.visualization.arrayToDataTable(spo2Data);
            spo2Chart = new google.visualization.ColumnChart(document.getElementById('spo2-chart'));
            spo2Chart.draw(spo2DataTable, spo2Options);
            
            // Draw Temperature Pie Chart
            const tempOptions = {
                title: '{{ 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©' if session.get('lang') == 'ar' else 'Temperature' }}',
                legend: { position: 'bottom' },
                backgroundColor: '#fef3c7',
                width: '100%',
                height: '100%',
                fontSize: 14,
                titleTextStyle: {
                    fontSize: 16,
                    bold: true
                },
                pieHole: 0.4,
                slices: {
                    0: { color: '#d97706' },
                    1: { color: '#f59e0b' },
                    2: { color: '#fbbf24' },
                    3: { color: '#f59e0b' },
                    4: { color: '#d97706' }
                }
            };
            
            const tempDataTable = google.visualization.arrayToDataTable(tempData);
            tempChart = new google.visualization.PieChart(document.getElementById('temp-chart'));
            tempChart.draw(tempDataTable, tempOptions);
        }
        
        function loadHistory(range = 'day') {
            const username = "{{ session.username }}";
            const infoElement = document.getElementById('chart-info');
            
            fetch(`/api/vitals-history/${username}?range=${range}`)
                .then(response => response.json())
                .then(data => {
                    if (data.count === 0) {
                        infoElement.textContent = '{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¹Ø±Ø¶.' if session.get('lang') == 'ar' else 'Not enough data to display.' }}';
                        document.getElementById('heart-rate-chart').innerHTML = '<p style="color: #64748b; text-align: center; padding: 50px 0;">{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.' if session.get('lang') == 'ar' else 'No data.' }}</p>';
                        document.getElementById('spo2-chart').innerHTML = '<p style="color: #64748b; text-align: center; padding: 50px 0;">{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.' if session.get('lang') == 'ar' else 'No data.' }}</p>';
                        document.getElementById('temp-chart').innerHTML = '<p style="color: #64748b; text-align: center; padding: 50px 0;">{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.' if session.get('lang') == 'ar' else 'No data.' }}</p>';
                        return;
                    }
                    
                    infoElement.textContent = `{{ 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©: ' if session.get('lang') == 'ar' else 'Data points: ' }}${data.count}`;
                    
                    // Draw charts
                    drawCharts(data);
                })
                .catch(error => {
                    console.error('History load error:', error);
                    infoElement.textContent = '{{ 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©.' if session.get('lang') == 'ar' else 'Failed to load historical data.' }}';
                    document.getElementById('heart-rate-chart').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 50px 0;">âš ï¸ {{ 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„.' if session.get('lang') == 'ar' else 'Load error.' }}</p>';
                    document.getElementById('spo2-chart').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 50px 0;">âš ï¸ {{ 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„.' if session.get('lang') == 'ar' else 'Load error.' }}</p>';
                    document.getElementById('temp-chart').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 50px 0;">âš ï¸ {{ 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„.' if session.get('lang') == 'ar' else 'Load error.' }}</p>';
                });
        }
        
        // TAB SWITCHING
        document.getElementById('realtime-tab').addEventListener('click', function() {
            document.getElementById('realtime-content').style.display = 'block';
            document.getElementById('history-content').style.display = 'none';
            this.style.background = '#3498db';
            this.style.color = 'white';
            this.style.border = '1px solid #3498db';
            document.getElementById('history-tab').style.background = '#e2e8f0';
            document.getElementById('history-tab').style.color = 'black';
            document.getElementById('history-tab').style.border = '1px solid #cbd5e1';
        });
        
        document.getElementById('history-tab').addEventListener('click', function() {
            document.getElementById('realtime-content').style.display = 'none';
            document.getElementById('history-content').style.display = 'block';
            this.style.background = '#3498db';
            this.style.color = 'white';
            this.style.border = '1px solid #3498db';
            document.getElementById('realtime-tab').style.background = '#e2e8f0';
            document.getElementById('realtime-tab').style.color = 'black';
            document.getElementById('realtime-tab').style.border = '1px solid #cbd5e1';
            
            // Initialize Google Charts if not already done
            if (typeof google !== 'undefined' && google.charts && google.charts.setOnLoadCallback) {
                google.charts.setOnLoadCallback(function() {
                    loadHistory('day');
                });
            } else {
                // If Google Charts not loaded yet, wait and then load
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.charts && google.charts.setOnLoadCallback) {
                        google.charts.setOnLoadCallback(function() {
                            loadHistory('day');
                        });
                    }
                }, 1000);
            }
        });
        
        // TIME RANGE BUTTONS
        document.querySelectorAll('.history-range').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.history-range').forEach(btn => {
                    btn.style.background = '#e2e8f0';
                    btn.style.color = 'black';
                    btn.style.border = '1px solid #cbd5e1';
                });
                this.style.background = '#3498db';
                this.style.color = 'white';
                this.style.border = '1px solid #3498db';
                loadHistory(this.dataset.range);
            });
        });
        
        // Initialize real-time loading
        if (window.location.hash === '#vitals') {
            loadVitals();
            setInterval(loadVitals, 5000);
        }
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('[href="#vitals"]')) {
                setTimeout(() => {
                    loadVitals();
                    setInterval(loadVitals, 5000);
                }, 100);
            }
        });
        </script>
    </div>

    <!-- REMINDERS SECTION -->
    <div id="reminders" style="margin-top: 20px; display: none;">
        <h3>{{ 'ğŸ”” ØªØ°ÙƒÙŠØ±Ø§Øª ØµØ­ÙŠØ©' if session.get('lang') == 'ar' else 'ğŸ”” Health Reminders' }}</h3>
        <ul style="padding-left: 20px; line-height: 1.8; margin-top: 15px; {{ 'text-align: right;' if session.get('lang') == 'ar' else '' }}">
            <li>{{ 'âœ… Ø®Ø° Ø£Ø¯ÙˆÙŠØªÙƒ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 8:00 ØµØ¨Ø§Ø­Ø§Ù‹' if session.get('lang') == 'ar' else 'âœ… Take medication at 8:00 AM' }}</li>
            <li>{{ 'ğŸ”„ Ø²Ø§Ù…Ù† Ø³ÙˆØ§Ø±Ùƒ Ø§Ù„ØµØ­ÙŠ ÙŠÙˆÙ…ÙŠØ§Ù‹' if session.get('lang') == 'ar' else 'ğŸ”„ Sync your Smart Health Band daily' }}</li>
            <li>{{ 'â¤ï¸ Ø±Ø§Ù‚Ø¨ Ù…Ø¹Ø¯Ù„ Ø¶Ø±Ø¨Ø§Øª Ù‚Ù„Ø¨Ùƒ ÙˆØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†' if session.get('lang') == 'ar' else 'â¤ï¸ Monitor your heart rate and SpOâ‚‚' }}</li>
            <li>{{ 'ğŸ“… Ø­Ø¶Ø± Ù„Ø²ÙŠØ§Ø±Ø§ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©' if session.get('lang') == 'ar' else 'ğŸ“… Attend your scheduled medical revisits' }}</li>
        </ul>
    </div>

    <!-- CSS FOR TABS -->
    <style>
    :target {
        display: block !important;
    }
    #calendar {
        display: block;
    }
    </style>
{% endif %}

{% endblock %}